# REA 本番デプロイ
#
# 使い方:
#   1. GitHub.com → REAリポジトリ → Actions タブ
#   2. 「Deploy to Production」を選択
#   3. 「Run workflow」ボタンをクリック
#
# 必要なSecrets:
#   - SERVER_HOST: サーバーIPアドレス
#   - SERVER_USER: SSHユーザー名
#   - SSH_PRIVATE_KEY: SSH秘密鍵

name: Deploy to Production

on:
  workflow_dispatch:  # 手動実行のみ

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e
            echo "========================================"
            echo "REA 本番デプロイ開始"
            echo "========================================"

            cd /opt/REA

            echo ""
            echo "=== 1/7 設定ファイルバックアップ ==="
            cp -f .env /tmp/env_backup || true
            cp -f rea-admin/.env.production /tmp/env_production_backup || true
            echo "完了"

            echo ""
            echo "=== 2/7 DBバックアップ ==="
            BACKUP_FILE="/tmp/rea_backup_$(date +%Y%m%d_%H%M%S).sql"
            sudo -u postgres pg_dump real_estate_db > $BACKUP_FILE
            echo "バックアップ: $BACKUP_FILE"

            echo ""
            echo "=== 3/7 コード更新 ==="
            git pull origin main
            echo "完了"

            echo ""
            echo "=== 4/7 設定ファイル復元 ==="
            cp -f /tmp/env_backup .env || true
            cp -f /tmp/env_production_backup rea-admin/.env.production || true
            echo "完了"

            echo ""
            echo "=== 5/7 フロントエンドビルド ==="
            cd rea-admin
            npm install --legacy-peer-deps
            npm run build
            cd ..
            echo "完了"

            echo ""
            echo "=== 6/7 API再起動 ==="
            sudo systemctl restart rea-api
            echo "完了"

            echo ""
            echo "=== 7/7 ヘルスチェック ==="
            sleep 3
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8005/health)
            if [ "$HTTP_CODE" = "200" ]; then
              echo "ヘルスチェック OK (HTTP $HTTP_CODE)"
            else
              echo "ヘルスチェック失敗 (HTTP $HTTP_CODE)"
              exit 1
            fi

            echo ""
            echo "========================================"
            echo "デプロイ完了"
            echo "========================================"
            echo "確認: https://realestateautomation.net/"
