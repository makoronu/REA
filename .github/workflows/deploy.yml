# REA 本番デプロイ
#
# 使い方:
#   1. GitHub.com → REAリポジトリ → Actions タブ
#   2. 「Deploy to Production」を選択
#   3. 「Run workflow」ボタンをクリック
#
# 必要なSecrets:
#   - SERVER_HOST: サーバーIPアドレス
#   - SERVER_USER: SSHユーザー名
#   - SSH_PRIVATE_KEY: SSH秘密鍵

name: Deploy to Production

on:
  workflow_dispatch:  # 手動実行のみ

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e
            echo "========================================"
            echo "REA 本番デプロイ開始"
            echo "========================================"

            cd /opt/REA

            echo ""
            echo "=== 1/9 設定ファイルバックアップ ==="
            cp -f .env /tmp/env_backup || true
            cp -f rea-admin/.env.production /tmp/env_production_backup || true
            echo "完了"

            echo ""
            echo "=== 2/9 DBバックアップ ==="
            BACKUP_FILE="/tmp/rea_backup_$(date +%Y%m%d_%H%M%S).sql"
            sudo -u postgres pg_dump real_estate_db > $BACKUP_FILE
            echo "バックアップ: $BACKUP_FILE"

            echo ""
            echo "=== 3/9 コード更新 ==="
            git fetch origin main
            git reset --hard origin/main
            echo "完了"

            echo ""
            echo "=== 4/9 設定ファイル復元 ==="
            cp -f /tmp/env_backup .env || true
            chmod 600 .env
            cp -f /tmp/env_production_backup rea-admin/.env.production || true
            echo "完了"

            echo ""
            echo "=== 5/9 フロントエンドビルド ==="
            cd rea-admin
            npm install --legacy-peer-deps
            npm run build
            cd ..
            echo "完了"

            echo ""
            echo "=== 6/9 API再起動 ==="
            sudo systemctl restart rea-api
            echo "完了"

            echo ""
            echo "=== 7/9 Geo API再起動 ==="
            test -f /etc/systemd/system/rea-geo.service && sudo systemctl restart rea-geo && echo "完了" || echo "rea-geo未設定（スキップ）"

            echo ""
            echo "=== 8/9 Scraper API再起動 ==="
            test -f /etc/systemd/system/rea-scr.service && sudo systemctl restart rea-scr && echo "完了" || echo "rea-scr未設定（スキップ）"

            echo ""
            echo "=== 9/9 ヘルスチェック ==="
            for endpoint in "Core API:8005:rea-api" "Geo API:8007:rea-geo" "Scraper API:8008:rea-scr"; do
              NAME="${endpoint%%:*}"
              REST="${endpoint#*:}"
              PORT="${REST%%:*}"
              SVC="${REST##*:}"
              REQUIRED=false
              test -f "/etc/systemd/system/${SVC}.service" && REQUIRED=true
              if [ "$REQUIRED" = false ]; then
                echo "${NAME}: 未設定（スキップ）"
                continue
              fi
              OK=false
              for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20; do
                HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${PORT}/health" 2>/dev/null) || true
                if [ "$HTTP_CODE" = "200" ]; then
                  echo "${NAME} ヘルスチェック OK（${i}回目、port ${PORT}）"
                  OK=true
                  break
                fi
                echo "${NAME} 待機中...（${i}/20）"
                sleep 5
              done
              if [ "$OK" = false ]; then
                echo "${NAME} ヘルスチェック失敗（port ${PORT}、20回リトライ後）"
                exit 1
              fi
            done

            echo ""
            echo "========================================"
            echo "デプロイ完了"
            echo "========================================"
            echo "確認: https://realestateautomation.net/"
