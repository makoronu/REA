# REA 学区機能 実装資料
**作成日**: 2025-12-11

---

## 概要

物件の座標（緯度・経度）から小学校・中学校の学区を自動判定する機能を実装。

---

## システム構成

### データベース

#### m_school_districts（学区ポリゴン）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | SERIAL | 主キー |
| school_type | VARCHAR | "小学校" or "中学校" |
| school_name | VARCHAR | 学校名 |
| address | VARCHAR | 住所 |
| prefecture_code | VARCHAR | 都道府県コード |
| prefecture_name | VARCHAR | 都道府県名 |
| admin_type | VARCHAR | 設置者（市区町村立等） |
| area | GEOMETRY(MultiPolygon) | 学区ポリゴン |

**データ件数**: 15,118件（小学校13,586 + 中学校1,532）

#### m_schools（学校位置）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | SERIAL | 主キー |
| school_code | VARCHAR | 学校コード |
| school_type | VARCHAR | "16001"=小学校, "16002"=中学校 |
| name | VARCHAR | 学校名 |
| address | VARCHAR | 住所 |
| admin_type_name | VARCHAR | "公立", "私立" 等 |
| latitude | DECIMAL | 緯度 |
| longitude | DECIMAL | 経度 |
| location | GEOMETRY(Point) | 位置（PostGIS） |

**データ件数**: 29,429校

---

## API

### GET /api/v1/geo/school-districts

座標から学校候補を取得

**パラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| lat | float | ○ | 緯度 |
| lng | float | ○ | 経度 |
| limit | int | × | 最大件数（デフォルト10） |

**レスポンス例**:
```json
{
  "elementary": [
    {
      "school_name": "大久保小学校",
      "address": "新宿区大久保1-1-21",
      "admin_type": "公立",
      "distance_meters": 681,
      "walk_minutes": 9,
      "is_in_district": true
    },
    {
      "school_name": "天神小学校",
      "address": "新宿区新宿6-14-2",
      "admin_type": "公立",
      "distance_meters": 615,
      "walk_minutes": 8,
      "is_in_district": false
    }
  ],
  "junior_high": [...],
  "latitude": 35.6938,
  "longitude": 139.7036
}
```

**ロジック**:
1. 学区ポリゴン（m_school_districts）から座標が含まれる学区を検索
2. 学校位置データ（m_schools）から距離順に最大10件取得
3. 学区ポリゴン内の学校は`is_in_district: true`
4. 学区内の学校を先頭に並び替え

---

### POST /api/v1/geo/properties/{property_id}/set-school-districts

物件の座標から学区を自動設定

**処理**:
1. 物件のlatitude/longitudeを取得
2. 学区ポリゴンから学区を判定
3. 最寄り学校までの距離を計算
4. propertiesテーブルを更新:
   - elementary_school
   - elementary_school_minutes
   - junior_high_school
   - junior_high_school_minutes

---

## フロントエンド

### コンポーネント: SchoolDistrictAutoFetchButton

**場所**: `rea-admin/src/components/form/DynamicForm.tsx`

**機能**:
1. 「座標から学校候補を取得」ボタン
2. APIから候補を取得して一覧表示
3. 候補をクリックで選択 → フォームに反映

**UI仕様**:
- 学区内の学校: 赤字 + 赤枠 + 「学区内」バッジ
- 選択済みの学校: 青枠
- 各候補に距離・徒歩分数を表示

---

## データソース

### 国土数値情報
- **A27**: 小学校区データ（平成28年度）
- **A32**: 中学校区データ（平成28年度）
- **P29**: 学校データ（令和3年度）

### 注意事項
- 学区ポリゴンは全国完全カバーではない
- 特に中学校区はデータが少ない（1,532件）
- 学区ポリゴンがない地域は最寄り学校をフォールバック表示

---

## ファイル一覧

### バックエンド
- `rea-api/app/api/api_v1/endpoints/geo.py` - APIエンドポイント

### フロントエンド
- `rea-admin/src/components/form/DynamicForm.tsx` - 学校選択UI

### スクリプト
- `scripts/import_school_districts.py` - 学区ポリゴンインポート
- `scripts/import_schools.py` - 学校位置インポート

---

## 次回実装予定

### バス停機能
- バス停データの取得（国土数値情報等）
- 最寄りバス停検索API
- フロントエンドUI

---

## 関連コミット

```
1400ea4 feat: 学区判定API追加（座標から小中学校区を自動判定）
c309ade feat: 物件編集画面に「学区を自動取得」ボタン追加
42a3c2f feat: DynamicFormの学区セクションに「座標から学区を自動取得」ボタン追加
3bc206d fix: 学区ポリゴンがない地域でも最寄りの学校を返すように改善
4c7efac feat: 学校候補を最大10件表示し選択可能に
```
