# テスト依頼書: Seg 9 - deleted_at IS NULLフィルタ追加（全コードベース残存14件）

**日付:** 2026-02-17
**対象コミット:** (未コミット)

---

## テスト対象

| ファイル | 変更内容 |
|----------|----------|
| properties.py | 元請会社集計にdeleted_atフィルタ追加 |
| zoho.py | UPSERT前チェック・既存物件チェック・リトライ時チェック（3箇所） |
| integrations.py | 同期状態一覧・総件数・サマリー・ZOHO同期済み件数（4箇所） |
| geo.py | 最寄駅設定・学区設定・用途地域設定の物件取得（3箇所） |
| images.py | 画像更新後取得 |
| touki.py | 登記適用時のremarks取得 |
| homes_exporter.py | HOMES出力のJOIN+WHERE（3テーブル） |

---

## 変更概要

全コードベースの残存deleted_at IS NULLフィルタ漏れ14件を修正。全てSELECTクエリのWHERE句にAND deleted_at IS NULLを追加（homes_exporterはLEFT JOINのON句にも追加）。動作ロジックの変更なし。

---

## テストケース

### 正常系

| # | テスト | 手順 | 期待結果 |
|---|--------|------|----------|
| 1 | 元請会社一覧 | 物件管理→元請会社連絡先 | 削除済み物件が集計に含まれない |
| 2 | ZOHO同期（新規） | ZOHOインポート実行 | 正常にインポートされる |
| 3 | ZOHO同期（既存更新） | 既存物件のZOHO再同期 | 正常に更新される |
| 4 | 同期状態一覧 | 連携→同期状態 | 削除済み物件が表示されない |
| 5 | 同期サマリー | 連携→サマリー | 件数が正確（削除済み除外） |
| 6 | 最寄駅設定 | 物件編集→最寄駅自動取得 | 正常に設定される |
| 7 | 学区設定 | 物件編集→学区自動判定 | 正常に設定される |
| 8 | 用途地域設定 | 物件編集→用途地域自動判定 | 正常に設定される |
| 9 | 画像更新 | 物件画像の表示順変更 | 正常に更新・返却される |
| 10 | 登記適用 | 登記データ→物件適用 | remarks正常追記 |
| 11 | HOMES出力 | ポータル→HOMES出力 | 正常にCSV出力される |
| 12 | 物件保存 | 物件編集→保存 | 正常に保存される |

### 攻撃ポイント

| # | 観点 | 確認内容 |
|---|------|----------|
| 13 | レグレッション（ZOHO連動） | 既存のZOHO同期が壊れていないこと |
| 14 | レグレッション（HOMES出力） | 出力CSVの件数・内容が正確であること |
| 15 | レグレッション（geo機能） | 最寄駅・学区・用途地域の自動取得が正常動作すること |
| 16 | LEFT JOIN整合性 | land_info/building_infoがない物件でもHOMES出力に含まれること |
| 17 | Python構文 | 全ファイル py_compile 通過済み |

---

## テスト環境

- API: `cd ~/my_programing/REA/rea-api && PYTHONPATH=~/my_programing/REA python -m uvicorn app.main:app --reload --port 8005`
- フロント: `cd ~/my_programing/REA/rea-admin && npm run dev`
