# テスト依頼書: Seg B - N+1クエリ解消（publication_validator + geo）

**日付:** 2026-02-17
**対象コミット:** (未コミット)

---

## テスト対象

| ファイル | 変更内容 |
|----------|----------|
| rea-api/app/services/publication_validator.py | バッチ取得関数追加、ループ内N+1クエリ解消 |
| rea-api/app/api/api_v1/endpoints/geo.py | get_facility_categories()をループ外に移動 |

---

## 変更概要

1. `get_column_labels_batch()`: valid_none_text + min_selectionsを一括取得する新関数
2. `validate_for_publication()`: ループ内の個別クエリをバッチ結果参照に変更（約60回→1回）
3. `get_nearest_facilities()`: カテゴリ取得をループ外に移動（N回→1回）

---

## テストケース

### 正常系 - 公開バリデーション

| # | テスト | 手順 | 期待結果 |
|---|--------|------|----------|
| 1 | 公開バリデーション（全項目入力済み） | 全必須項目を入力した物件で「公開」に変更 | バリデーション通過、ステータス変更成功 |
| 2 | 公開バリデーション（未入力あり） | 必須項目を数件空にして「公開」に変更 | バリデーションエラー、未入力フィールド一覧が返る |
| 3 | 公開バリデーション（「なし」入力） | 必須項目に「なし」「該当なし」を入力 | 有効値として扱われ、バリデーション通過 |
| 4 | 公開バリデーション（min_selections） | multi_selectフィールドで最小選択数未満 | バリデーションエラー |
| 5 | 公開バリデーション（条件付き除外） | use_district=「無指定」時にbuilding_coverage_ratioが空 | 除外されてバリデーション通過 |
| 6 | 非公開→非公開 | 「非公開」のまま保存 | バリデーションスキップ |
| 7 | 公開前確認 | 「公開前確認」で物件を開く | 自動バリデーション実行、結果が正しい |

### 正常系 - 周辺施設検索

| # | テスト | 手順 | 期待結果 |
|---|--------|------|----------|
| 8 | 周辺施設検索 | 有効な座標で /geo/nearest-facilities を呼び出し | 施設一覧にcategory_nameが正しく表示 |
| 9 | カテゴリ別施設検索 | /geo/nearest-facilities-by-category を呼び出し | カテゴリ別に施設が返る（既存動作維持） |

### 異常系

| # | テスト | 手順 | 期待結果 |
|---|--------|------|----------|
| 10 | DB接続エラー時のフォールバック | （手動テスト困難） | バッチ取得失敗→デフォルト値使用→正常動作 |

### 攻撃ポイント

| # | 観点 | 確認内容 |
|---|------|----------|
| 11 | レグレッション | 既存の公開バリデーションが全種別で正しく動作すること |
| 12 | パフォーマンス | 物件編集画面のバリデーション応答速度が改善（体感確認） |

---

## テスト環境

- API: `cd ~/my_programing/REA/rea-api && PYTHONPATH=~/my_programing/REA python -m uvicorn app.main:app --reload --port 8005`
- フロント: `cd ~/my_programing/REA/rea-admin && npm run dev`
