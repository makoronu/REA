# テスト依頼書: Seg 6 - deleted_at漏れ修正

**日付:** 2026-02-17
**対象コミット:** (未コミット)

---

## テスト対象

| ファイル | 変更内容 |
|----------|----------|
| rea-api/app/api/api_v1/endpoints/registries.py | properties存在確認にdeleted_atフィルタ追加（2箇所） |
| rea-api/app/api/api_v1/endpoints/touki.py | touki_imports/touki_records/properties/land_info/building_infoの全SELECTにdeleted_atフィルタ追加（14箇所） |
| rea-api/app/crud/generic.py | 関連テーブル存在確認にdeleted_atフィルタ追加（1箇所） |

---

## 変更概要

論理削除対応漏れ修正17件。全テーブルにdeleted_atカラムが存在するにもかかわらず、SELECTクエリで`AND deleted_at IS NULL`が欠落していた箇所を修正。論理削除されたレコードが取得・参照されるバグを解消。

---

## テストケース

### 正常系

| # | テスト | 手順 | 期待結果 |
|---|--------|------|----------|
| 1 | 物件登記一覧取得 | 物件詳細→登記情報タブ | 正常に登記一覧が表示される |
| 2 | 登記情報追加 | 物件詳細→登記情報→新規追加 | 正常に追加される |
| 3 | 登記インポート一覧 | 登記管理→インポート一覧 | 一覧が正常に表示される |
| 4 | 登記インポート詳細 | 一覧→詳細表示 | 詳細が正常に表示される |
| 5 | 登記テキストパース | インポート→パース実行 | 正常にパースされる |
| 6 | 登記レコード一覧 | 登記管理→レコード一覧 | 一覧が正常に表示される |
| 7 | 登記レコード詳細 | 一覧→詳細表示 | 詳細が正常に表示される |
| 8 | 登記→物件作成 | レコード選択→物件作成 | 物件が正常に作成される |
| 9 | 登記→物件反映 | レコード選択→既存物件に反映 | 土地・建物情報が反映される |
| 10 | 登記→物件リンク | レコード選択→物件にリンク | リンクが正常に作成される |
| 11 | 物件編集保存 | 物件編集→値変更→保存 | 正常に保存される（generic.py経路） |

### 異常系・境界値

| # | テスト | 手順 | 期待結果 |
|---|--------|------|----------|
| 12 | 論理削除済み物件への登記追加 | 削除済み物件IDで登記追加API呼出 | 404「物件が見つかりません」 |
| 13 | 論理削除済み登記レコード参照 | 削除済みレコードIDで詳細取得 | 404 ResourceNotFound |
| 14 | 論理削除済みレコードで物件作成 | 削除済みレコードIDで物件作成API呼出 | ResourceNotFoundエラー |
| 15 | フィルタ付きインポート一覧 | status=parsedでフィルタ | 削除済みを除外した正しい件数 |
| 16 | フィルタ付きレコード一覧 | document_type=landでフィルタ | 削除済みを除外した正しい件数 |

### 攻撃ポイント

| # | 観点 | 確認内容 |
|---|------|----------|
| 17 | レグレッション（登記フロー） | 登記CSV取込→パース→物件作成の一連フローが壊れていないこと |
| 18 | レグレッション（物件保存） | 物件編集→保存で関連テーブル（land_info, building_info）の更新が壊れていないこと |
| 19 | 件数整合性 | インポート一覧・レコード一覧の件数が削除済みを含まない正しい数であること |
| 20 | Python | コンパイルエラーなし（py_compile通過済み） |

---

## テスト環境

- API: `cd ~/my_programing/REA/rea-api && PYTHONPATH=~/my_programing/REA python -m uvicorn app.main:app --reload --port 8005`
- フロント: `cd ~/my_programing/REA/rea-admin && npm run dev`
