# テスト依頼: Seg3a 坪単価・仲介手数料自動計算

**作成日**: 2026-01-07
**依頼者**: Claude
**対象コミット**: c30e989

---

## 概要

物件保存時に坪単価・仲介手数料を自動計算。

---

## テスト対象

### 変更箇所

| 種別 | 対象 | 内容 |
|------|------|------|
| API | shared/constants.py | TAX_RATE, SQM_TO_TSUBO, AKIYA_SPECIAL_* 追加 |
| API | shared/real_estate_utils.py | calculate_price_per_tsubo, calculate_brokerage_fee 追加 |
| API | properties.py | 保存時自動計算ロジック追加 |

### 計算仕様

#### 坪単価
- 計算式: `sale_price ÷ (land_area × 0.3025)`
- 常に再計算（手動編集不可）

#### 仲介手数料
- 速算法:
  - 400万円超: 価格×3%+6万円+消費税
  - 200万円超〜400万円: 価格×4%+2万円+消費税
  - 200万円以下: 価格×5%+消費税
- 空き家特例: 800万円以下は上限33万円（税込）
- 既存値がある場合は上書きしない（編集可能）

---

## テストケース

### 正常系

| # | テスト項目 | 手順 | 期待結果 |
|---|-----------|------|----------|
| 1 | 坪単価計算（通常） | 価格3000万円、土地面積100㎡の物件を保存 | price_per_tsubo ≒ 991,736円 |
| 2 | 坪単価計算（高額） | 価格1億円、土地面積200㎡の物件を保存 | price_per_tsubo ≒ 1,652,893円 |
| 3 | 仲介手数料（400万円超） | 価格3000万円の物件を保存 | brokerage_fee = 1,056,000円 |
| 4 | 仲介手数料（200〜400万円） | 価格300万円の物件を保存 | brokerage_fee = 154,000円 |
| 5 | 仲介手数料（200万円以下） | 価格150万円の物件を保存 | brokerage_fee = 82,500円 |
| 6 | 空き家特例適用 | 価格700万円の物件を保存 | brokerage_fee = 297,000円（上限未満）|
| 7 | 空き家特例上限 | 価格800万円の物件を保存 | brokerage_fee = 330,000円（上限適用）|
| 8 | 仲介手数料既存値保持 | 仲介手数料を手動設定後、価格変更して保存 | 手動設定値が保持される |
| 9 | 価格変更時の坪単価再計算 | 既存物件の価格を変更して保存 | price_per_tsuboが再計算される |
| 10 | 面積変更時の坪単価再計算 | 既存物件の土地面積を変更して保存 | price_per_tsuboが再計算される |

### 異常系

| # | テスト項目 | 手順 | 期待結果 |
|---|-----------|------|----------|
| 1 | 価格なし | 価格未入力で保存 | 坪単価・仲介手数料は計算されない（NULLのまま） |
| 2 | 面積なし | 土地面積未入力で保存 | 坪単価は計算されない、仲介手数料は計算される |
| 3 | 価格0円 | 価格を0で保存 | 坪単価・仲介手数料は計算されない |
| 4 | 面積0㎡ | 土地面積を0で保存 | 坪単価は計算されない |

---

## 攻撃ポイント

| # | 観点 | 確認内容 |
|---|------|----------|
| 1 | 境界値 | 400万円、200万円、800万円（空き家特例）ちょうどの価格 |
| 2 | 精度 | 小数点以下の丸め（円単位で整数化） |
| 3 | 大きな値 | 10億円以上の物件でオーバーフローしないか |
| 4 | 物件種別依存 | マンション/アパート/一戸建て/土地すべてで動作するか |
| 5 | 既存データ影響 | 既存物件の仲介手数料が上書きされないか |

---

## 計算検証

### 坪単価
```
価格3000万円、面積100㎡の場合:
坪数 = 100 × 0.3025 = 30.25坪
坪単価 = 30,000,000 ÷ 30.25 = 991,735.5円
→ 四捨五入して 991,736円
```

### 仲介手数料（3000万円の場合）
```
手数料（税抜） = 30,000,000 × 0.03 + 60,000 = 960,000円
手数料（税込） = 960,000 × 1.10 = 1,056,000円
```

### 仲介手数料（800万円の場合、空き家特例）
```
手数料（税抜） = 8,000,000 × 0.03 + 60,000 = 300,000円
手数料（税込） = 300,000 × 1.10 = 330,000円
→ 空き家特例上限33万円なので 330,000円
```

---

## テスト環境

| 項目 | 値 |
|------|-----|
| ローカルAPI | http://localhost:8005 |
| ローカルフロント | http://localhost:5173 |
| 本番URL | https://realestateautomation.net/ |

---

## ロールバック手順

```bash
# コード変更を元に戻す
git checkout shared/constants.py shared/real_estate_utils.py rea-api/app/api/api_v1/endpoints/properties.py
```

