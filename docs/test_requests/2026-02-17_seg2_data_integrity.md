# テスト依頼書: Seg 2 - データ整合性修正

**日付:** 2026-02-17
**対象コミット:** (未コミット)

---

## テスト対象

| ファイル | 変更内容 |
|----------|----------|
| rea-api/app/crud/generic.py | update()にcommitパラメータ追加（部分コミット防止） |
| rea-api/app/services/publication_validator.py | 同一ステータス保存時のバリデーションスキップ削除 |
| rea-api/app/api/api_v1/endpoints/registries.py | deleted_at IS NULLフィルタ13箇所追加 |
| rea-api/app/api/api_v1/endpoints/zoho.py | deleted_at IS NULLフィルタ3箇所追加 |
| rea-api/app/api/api_v1/endpoints/users.py | メール送信try/except + メール重複チェックis_active追加 |

---

## 変更概要

データ整合性に関わるバグ7件の修正。物件更新時の部分コミット防止、公開ステータス保存時のバリデーション漏れ修正、論理削除レコードの除外フィルタ追加（登記情報16箇所）、メール送信失敗時のロールバック防止。

---

## テストケース

### 正常系

| # | テスト | 手順 | 期待結果 |
|---|--------|------|----------|
| 1 | 物件更新（全テーブル） | 物件編集→基本情報+土地情報+建物情報を変更→保存 | 全テーブルが一括で更新される |
| 2 | 物件更新（propertiesのみ） | 物件編集→物件名だけ変更→保存 | 正常に保存される |
| 3 | 公開ステータス維持保存 | 公開中物件→別フィールドを変更→保存 | バリデーションが実行される |
| 4 | 登記一覧取得 | 物件詳細→登記タブ→登記一覧 | 論理削除されていないレコードのみ表示 |
| 5 | 登記詳細取得 | 登記情報→詳細表示 | 正常に表示される |
| 6 | 登記更新 | 登記情報→編集→保存 | 正常に保存される |
| 7 | 甲区一覧取得 | 登記詳細→甲区タブ | 論理削除されていないエントリのみ表示 |
| 8 | 甲区追加 | 登記詳細→甲区追加 | 正常に追加される |
| 9 | 甲区更新 | 甲区エントリ→編集→保存 | 正常に保存される |
| 10 | 乙区一覧取得 | 登記詳細→乙区タブ | 論理削除されていないエントリのみ表示 |
| 11 | 乙区追加 | 登記詳細→乙区追加 | 正常に追加される |
| 12 | 乙区更新 | 乙区エントリ→編集→保存 | 正常に保存される |
| 13 | ユーザー作成 | 設定→ユーザー管理→新規作成 | ユーザー作成成功（メール送信も実行） |
| 14 | 登記全情報取得 | 登記情報→全情報表示 | 表題部+甲区+乙区が正常に表示 |

### 異常系・データ整合性

| # | テスト | 手順 | 期待結果 |
|---|--------|------|----------|
| 15 | 部分コミット検証 | 物件編集→properties+building_info変更→building_info側でエラー発生 | properties/building_infoともにロールバックされる |
| 16 | 公開中物件の再保存 | 公開中物件→必須項目を空にして保存 | バリデーションエラーが表示される |
| 17 | 論理削除済み登記 | 論理削除された登記のIDで直接APIアクセス | 404エラー |
| 18 | 論理削除済み甲区 | 論理削除された甲区のIDで更新API | 404エラー |
| 19 | 論理削除済み乙区 | 論理削除された乙区のIDで更新API | 404エラー |
| 20 | メール送信失敗 | SMTPサーバー未設定状態でユーザー作成 | ユーザーは作成される（メール失敗はログのみ） |
| 21 | 無効化済みメール再利用 | 無効化済みユーザーと同じメールで新規作成 | 作成可能 |

### 攻撃ポイント

| # | 観点 | 確認内容 |
|---|------|----------|
| 22 | レグレッション | ログイン状態で全機能が変更前と同一に動作すること |
| 23 | ZOHO同期 | 論理削除された物件がZOHO同期に含まれないこと |
| 24 | Python | コンパイルエラーなし（py_compile通過済み） |

---

## テスト環境

- API: `cd ~/my_programing/REA/rea-api && PYTHONPATH=~/my_programing/REA python -m uvicorn app.main:app --reload --port 8005`
- フロント: `cd ~/my_programing/REA/rea-admin && npm run dev`
