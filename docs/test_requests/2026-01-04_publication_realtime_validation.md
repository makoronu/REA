# テスト依頼書: 公開バリデーション リアルタイムチェック

**作成日**: 2026-01-04
**コミット**: bf4b4b2
**担当**: Claude

---

## 概要

公開ステータスを「公開」または「会員公開」に変更した際に、リアルタイムでバリデーションを実行し、不足項目があれば保存ボタンを無効化する機能。

---

## テスト対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `rea-api/app/api/api_v1/endpoints/properties.py` | validate-publication API追加 |
| `rea-admin/src/constants/apiPaths.ts` | APIパス追加 |
| `rea-admin/src/components/form/DynamicForm.tsx` | リアルタイムバリデーション実装 |

---

## テスト環境

- ローカル: http://localhost:5173
- API: http://localhost:8005
- 本番: https://realestateautomation.net/ （デプロイ後）

---

## テストケース

### 1. リアルタイムバリデーション（正常系）

| # | 操作 | 期待結果 |
|---|------|---------|
| 1-1 | 必須項目が全て入力済みの物件で「公開」を選択 | エラー表示なし、保存ボタン有効（緑） |
| 1-2 | 必須項目が全て入力済みの物件で「会員公開」を選択 | エラー表示なし、保存ボタン有効（緑） |
| 1-3 | 公開状態から「非公開」に変更 | バリデーション実行されない、保存ボタン有効 |

### 2. リアルタイムバリデーション（エラー系）

| # | 操作 | 期待結果 |
|---|------|---------|
| 2-1 | 必須項目が不足している物件で「公開」を選択 | 赤いエラーバー表示、保存ボタン無効（グレー） |
| 2-2 | エラー表示中に「詳細を見る」をクリック | エラーモーダルが開く |
| 2-3 | エラーモーダルでグループ名をクリック | 該当タブに切り替わり、モーダルが閉じる |
| 2-4 | エラー表示中に「非公開」を選択 | エラー表示が消え、保存ボタンが有効になる |

### 3. 保存ボタン無効化

| # | 操作 | 期待結果 |
|---|------|---------|
| 3-1 | バリデーションエラー時に保存ボタンをクリック | クリック無効、何も起きない |
| 3-2 | 保存ボタンのスタイル確認 | グレーアウト、カーソル not-allowed |

### 4. フィールド移動

| # | 操作 | 期待結果 |
|---|------|---------|
| 4-1 | エラーモーダルで「所在地」グループをクリック | 所在地・周辺情報タブに切り替わる |
| 4-2 | エラーモーダルで「価格情報」グループをクリック | 価格・取引タブに切り替わる |
| 4-3 | エラーモーダルで「基本情報」グループをクリック | 基本情報タブに切り替わる |
| 4-4 | タブ切り替え後 | ページトップにスクロール |

### 5. APIエンドポイント

| # | テスト内容 | 期待結果 |
|---|-----------|---------|
| 5-1 | `GET /properties/{id}/validate-publication?target_status=公開` | is_valid: true/false を返す |
| 5-2 | 存在しない物件IDで呼び出し | 404エラー |
| 5-3 | 認証なしで呼び出し | 401エラー |

---

## 攻撃ポイント

1. **新規物件（未保存）での動作**
   - formData.id が存在しない場合はAPIを呼ばないこと

2. **連続クリック**
   - 公開→会員公開を素早く切り替えた場合の挙動

3. **ネットワークエラー**
   - API呼び出し失敗時はエラーを握りつぶしてログ出力のみ

4. **タブマッピング漏れ**
   - 存在しないグループ名の場合、モーダルを閉じるのみ

---

## 確認コマンド

```bash
# API動作確認
curl -X GET "http://localhost:8005/api/v1/properties/1/validate-publication?target_status=公開" \
  -H "Cookie: session=..."

# レスポンス例（エラー時）
{
  "is_valid": false,
  "message": "「公開」にするには以下の項目が必要です",
  "groups": {
    "所在地": ["郵便番号", "住所"],
    "価格情報": ["販売価格"]
  }
}
```

---

## 合格基準

- [ ] 全テストケースがPASS
- [ ] 攻撃ポイントで問題なし
- [ ] TypeScriptビルドエラーなし
