# テスト依頼書: 空き家特例 仲介手数料修正

**作成日**: 2026-01-16
**対象機能**: 仲介手数料の自動計算（空き家特例）

---

## 1. 変更概要

800万円以下の物件に対する空き家特例の適用ロジックを修正。

| 項目 | 修正前 | 修正後 |
|------|--------|--------|
| 適用方法 | `min(計算結果, 33万円)` | 一律33万円（固定） |
| 例: 500万円 | 23.1万円 | **33万円** |
| 例: 200万円 | 11万円 | **33万円** |

---

## 2. テスト対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `shared/real_estate_utils.py` | `calculate_brokerage_fee()` 関数修正 |

---

## 3. テストケース

### 3.1 正常系

| No | 売買価格 | 期待結果 | 確認方法 |
|----|----------|----------|----------|
| 1 | 200万円 | 33万円（330,000円） | 物件作成→仲介手数料確認 |
| 2 | 500万円 | 33万円（330,000円） | 物件作成→仲介手数料確認 |
| 3 | 800万円 | 33万円（330,000円） | 物件作成→仲介手数料確認 |
| 4 | 801万円 | 30.03万円（300,300円） | 物件作成→仲介手数料確認 |
| 5 | 1000万円 | 39.6万円（396,000円） | 物件作成→仲介手数料確認 |
| 6 | 3000万円 | 105.6万円（1,056,000円） | 物件作成→仲介手数料確認 |

### 3.2 境界値テスト

| No | 売買価格 | 期待結果 | 備考 |
|----|----------|----------|------|
| 1 | 7,999,999円 | 330,000円 | 800万円未満 |
| 2 | 8,000,000円 | 330,000円 | ちょうど800万円 |
| 3 | 8,000,001円 | 300,300円 | 800万円超（速算法適用） |

### 3.3 異常系

| No | 入力 | 期待結果 |
|----|------|----------|
| 1 | 0円 | 計算なし（NULLまたは空欄） |
| 2 | マイナス値 | 計算なし |
| 3 | 空欄 | 計算なし |

---

## 4. 確認手順

1. 管理画面にログイン
2. 新規物件作成（または既存物件編集）
3. 売買価格を入力（上記テストケースの値）
4. 保存後、仲介手数料フィールドの値を確認
5. 期待結果と一致することを確認

---

## 5. 環境情報

- API: FastAPI（ポート8005）
- 関数: `shared/real_estate_utils.py:calculate_brokerage_fee()`
- 定数: `AKIYA_SPECIAL_PRICE_LIMIT = 8,000,000`
- 定数: `AKIYA_SPECIAL_FEE_LIMIT = 330,000`

---

## 6. 注意事項

- 仲介手数料は**既存値がない場合のみ**自動計算される
- 既存物件で手数料が入力済みの場合は上書きされない
- テストは**新規物件作成**で実施すること

---

## 7. 計算式（参考）

```
【空き家特例（800万円以下）】
仲介手数料 = 330,000円（固定）

【速算法（800万円超）】
400万円超: (価格 × 3% + 6万円) × 1.10
200万円超〜400万円: (価格 × 4% + 2万円) × 1.10
200万円以下: (価格 × 5%) × 1.10
```
