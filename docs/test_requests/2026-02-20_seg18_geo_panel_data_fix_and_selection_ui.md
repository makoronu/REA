# テスト依頼書: Seg 18a+18b GeoPanel データ構造修正 + 選択UI追加

## 日時
2026-02-20

## コミット
- Seg 18a: `6d5cdf8` fix: GeoPanel handleApplyバス停・施設データ構造修正
- Seg 18b: `7ac9305` feat: 駅・バス停・施設の選択UI追加

## 変更ファイル
- `rea-admin/src/components/form/GeoPanel.tsx`

## 変更概要

### Seg 18a: データ構造バグ修正
- バス停: `{name, routes}` → `{bus_stop_name, line_name}`（BusStopsFieldの期待構造に合わせ）
- 施設: `{name}` → `{facility_name}` + `distance_meters`追加（NearbyFacilitiesFieldの期待構造に合わせ）

### Seg 18b: 選択UI追加
- 駅: 上位3件自動表示のみ → 全候補チェックボックスリスト（デフォルト上位3件選択）
- バス停: 上位3件自動表示のみ → 全候補チェックボックスリスト（デフォルト上位5件選択）
- 施設: カテゴリ件数のみ → カテゴリ別個別施設リスト+チェックボックス（デフォルト各カテゴリ最寄り1件選択）
- handleApply: 固定slice → 選択状態ベースのfilter

---

## テスト項目

### 前提
- 物件編集ページを開く
- 所在地・周辺情報タブの「周辺情報を管理」ボタンからGeoPanelを開く

### T1: 基本動作（一括取得 → 選択 → 反映）
1. 地図上でピンを設置
2. 「この位置で周辺情報を一括取得」ボタンクリック
3. **確認**: 駅・バス停・施設がチェックボックス付きリストで表示される
4. **確認**: 駅はデフォルト上位3件にチェック、バス停は上位5件にチェック
5. **確認**: 施設は各カテゴリの最寄り1件にチェック
6. 「フォームに反映して閉じる」クリック
7. **確認**: フォーム側の電車・鉄道/バス/周辺施設に選択した項目が反映されている

### T2: バス停データ構造（Seg 18a修正確認）
1. GeoPanelで一括取得 → フォームに反映
2. バスセクションを確認
3. **確認**: バス停名が表示されている（空欄やundefinedでない）
4. **確認**: 路線名が表示されている（routes配列が「・」区切りで結合されている）

### T3: 施設データ構造（Seg 18a修正確認）
1. GeoPanelで一括取得 → フォームに反映
2. 周辺施設セクションを確認
3. **確認**: 施設名が表示されている（空欄やundefinedでない）
4. **確認**: 距離(m)が表示されている（0やNaNでない）

### T4: チェックボックス選択操作
1. 一括取得後、駅リストで1件チェックを外す
2. **確認**: ヘッダの「N件選択中」が1減る
3. 別の駅にチェックを入れる
4. **確認**: 「N件選択中」が1増える
5. バス停・施設でも同様にチェック操作
6. 「フォームに反映して閉じる」クリック
7. **確認**: チェックした項目のみがフォームに反映される（チェックを外したものは含まれない）

### T5: 全チェック解除
1. 駅のチェックをすべて外す
2. 「フォームに反映して閉じる」クリック
3. **確認**: フォームのtransportationが空になる（エラーは出ない）

### T6: ピン移動後の再取得
1. 一括取得後、チェック状態を変更
2. 地図上でピンを別の場所にドラッグ
3. **確認**: 結果表示が消える
4. 再度「一括取得」クリック
5. **確認**: 新しい結果が表示され、デフォルト選択状態にリセットされる

### T7: 施設カテゴリ別表示
1. 一括取得後、施設セクションを確認
2. **確認**: カテゴリ名（コンビニ、スーパー等）ごとにグループ化されている
3. **確認**: 各施設に名前・距離(m)・徒歩分数が表示されている

---

## 攻撃ポイント
- 座標が海上や離島（駅0件・バス停0件）のケース → 「候補なし」表示
- 施設が1カテゴリしかないケース
- 大量候補（駅10件以上）のケースでのスクロール
- 取得中にピンを移動 → 結果クリア

## テスト環境
- URL: https://realestateautomation.net/（デプロイ後）
- ブラウザ: Chrome最新
