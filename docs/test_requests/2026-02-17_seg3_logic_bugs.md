# テスト依頼書: Seg 3 - ロジックバグ修正

**日付:** 2026-02-17
**対象コミット:** (未コミット)

---

## テスト対象

| ファイル | 変更内容 |
|----------|----------|
| rea-admin/src/hooks/useAutoSave.ts | flush()で保存実行するようlastArgs追跡追加 |
| rea-admin/src/components/CommandPalette.tsx | '成約済'→'成約済み'（1文字修正） |
| rea-api/app/api/api_v1/endpoints/geo.py | is_primary判定をDESCに統一 + 学校検索半径をschoolに修正 |
| rea-admin/src/pages/admin/FieldVisibilityPage.tsx | テーブル切替時にpendingChangesクリア |
| rea-admin/src/pages/Properties/PropertiesPage.tsx | Promise.all→Promise.allSettled（2箇所） |

---

## 変更概要

ロジックバグ6件の修正。自動保存hook（flush未実行）、用途地域is_primary判定不整合、学校検索半径誤使用、ステータス表示文字列不一致、設定画面テーブル切替時の変更混在、一括更新の部分失敗処理。

---

## テストケース

### 正常系

| # | テスト | 手順 | 期待結果 |
|---|--------|------|----------|
| 1 | 自動保存→ページ遷移 | 物件編集→値変更→即座にページ遷移（ブラウザの戻る） | 変更が保存される（再表示時に値が反映されている） |
| 2 | 自動保存→タブ非表示 | 物件編集→値変更→別タブに切替 | 変更が保存される |
| 3 | 自動保存→通常保存 | 物件編集→値変更→デバウンス時間待機 | 自動保存が実行される |
| 4 | 用途地域取得GET | 法令調査→用途地域ボタン（取得のみ） | 面積最大がis_primary=trueとなる |
| 5 | 用途地域設定POST | 法令調査→用途地域ボタン（設定保存） | GETと同じis_primary判定 |
| 6 | 学校区設定 | 法令調査→学区設定ボタン | 半径3000m以内で検索され結果が返る |
| 7 | コマンドパレット | Ctrl+K→成約済み物件を検索 | 成約済みの物件名が青色で表示される |
| 8 | フィールド表示設定 | 管理→フィールド表示→テーブル切替 | 切替時にpendingChangesがクリアされる |
| 9 | 一括ステータス変更 | 複数物件選択→ステータス一括変更 | 成功分のみUI反映される |
| 10 | 一括取下げ | 複数物件選択→一括取下げ | 成功分のみUI反映される |

### 異常系・境界値

| # | テスト | 手順 | 期待結果 |
|---|--------|------|----------|
| 11 | 自動保存キャンセル | 物件編集→値変更→即座にキャンセルボタン | 保存されない（lastArgsがクリアされる） |
| 12 | 一括更新部分失敗 | 複数物件選択（一部は権限なし等）→一括更新 | 「X件成功、Y件失敗」メッセージ表示、成功分はUI反映 |
| 13 | テーブル切替+未保存 | フィールド表示→変更→テーブル切替→元テーブルに戻る | 変更がクリアされている |
| 14 | 用途地域なし | 用途地域マスタデータがない座標で取得 | 空配列が返る |

### 攻撃ポイント

| # | 観点 | 確認内容 |
|---|------|----------|
| 15 | レグレッション | 自動保存の通常動作（デバウンス後の保存）が壊れていないこと |
| 16 | 用途地域整合性 | GET/POSTでis_primaryの結果が一致すること |
| 17 | TypeScript | ビルドエラーなし（tsc --noEmit通過済み） |
| 18 | Python | コンパイルエラーなし（py_compile通過済み） |

---

## テスト環境

- API: `cd ~/my_programing/REA/rea-api && PYTHONPATH=~/my_programing/REA python -m uvicorn app.main:app --reload --port 8005`
- フロント: `cd ~/my_programing/REA/rea-admin && npm run dev`
