# テスト依頼書: Seg 19 reinfolib XKT001/XKT014 区域区分取得バグ修正

## 日付
2026-02-22

## 変更概要
reinfolib API XKT001（都市計画区域）とXKT014（防火地域）で、複数ポリゴンがヒットした際に誤った区域区分が返されるバグを修正。

### 問題
- XKT001: kubun_id=21（都市計画区域＝広域）が常に先にヒット → 市街化区域でも「非線引区域」と判定
- XKT014: 境界で準防火地域(kubun_id=25)が先にヒット → 防火地域が準防火に誤判定

### 修正内容
- `client.py`: API定義に`preferred_kubun_ids`を追加。features取得後にkubun_idフィルタ+優先順ソート
- `RegulationPanel.tsx`: `!== undefined` → `!= null` に変更（null値のsetValue防止）

## 変更ファイル
| ファイル | 変更行数 | 変更内容 |
|----------|---------|----------|
| rea-api/app/services/reinfolib/client.py | +30/-2 | preferred_kubun_ids追加+フィルタロジック |
| rea-admin/src/components/form/RegulationPanel.tsx | +6/-6 | null防御統一 |

## テスト対象

### テスト1: 市街化区域の正常判定
1. 物件編集画面を開く
2. 緯度経度に市街化区域の座標を入力（例: 35.6938, 139.7035 新宿区役所）
3. 「法令制限を自動取得」パネルを開く
4. 「この座標で法令制限を自動取得」ボタンを押す
5. **期待**: 取得結果テーブルの「都市計画」行に「市街化区域」と表示（●印=反映対象）
6. 「フォームに反映して閉じる」を押す
7. **期待**: 都市計画フィールドに「市街化区域」が選択される

### テスト2: 防火地域の正常判定
1. テスト1と同じ座標（新宿区役所）で実行
2. **期待**: 取得結果テーブルの「防火地域」行に「防火地域」と表示

### テスト3: 複数都市での確認
以下の座標でテスト1・2を繰り返す:
| 都市 | 緯度 | 経度 | 期待(都市計画) | 期待(防火) |
|------|------|------|-------------|----------|
| 新宿区 | 35.6938 | 139.7035 | 市街化区域 | 防火地域 |
| 札幌市 | 43.0621 | 141.3544 | 市街化区域 | 防火地域 |
| 名古屋市 | 35.1709 | 136.8815 | 市街化区域 | 準防火地域 |

### テスト4: 該当なしケース
1. 都市計画区域外の座標を入力（例: 43.8333, 144.1 美幌町）
2. **期待**: 都市計画が取得結果に表示されない or 該当なし
3. **期待**: フォームの都市計画フィールドが変更されない

### テスト5: null値のsetValue防止
1. api_aliasesにマッチしない区域が返された場合
2. **期待**: フォームフィールドが`[null]`にならない（既存値が保持される）

## 攻撃ポイント
- 都市計画区域と区域区分の境界にある座標
- 防火地域と準防火地域の境界にある座標
- reinfolib APIがデータを返さない地域（離島等）

## 環境
- ローカル: rea-api :8005, rea-admin :5173
- 本番: https://realestateautomation.net/

## ロールバック
- DB変更なし
- コード2ファイルのみ（git revert可能）
