# 公開時バリデーション機能 テストレポート

**テスト実施日:** 2026-01-03
**テスト担当:** Claude (敵対的テスト実施)
**対象機能:** 物件の公開ステータス変更時の必須項目バリデーション

---

## 総合判定

| 判定 | 内容 |
|------|------|
| **機能テスト** | ✓ PASS |
| **セキュリティ** | ❌ FAIL（重大な問題あり） |
| **UI/UX** | ✓ PASS |

### ⚠️ 緊急対応必要

**認証なしでAPIにフルアクセス可能な状態です。**

- 認証なしで物件データの読み取りが可能
- 認証なしで物件データの更新が可能
- 本番環境では既に認証が適用されているか要確認

---

## 1. APIテスト結果

### 正常系テスト

| No | テスト内容 | 期待結果 | 実際結果 | 判定 |
|----|-----------|---------|---------|------|
| 1 | 必須項目未入力でdetachedを「公開」 | 400エラー + グループ別未入力リスト | 400 + groups形式で返却 | ✓ |
| 2 | 土地(land)を「公開」 | 必須項目なしで成功 | 200 成功 | ✓ |
| 3 | 「非公開」への変更 | バリデーションなしで成功 | 200 成功 | ✓ |
| 4 | 「会員公開」への変更 | バリデーション必須 | 400 エラー | ✓ |

**バリデーションエラーレスポンス例:**
```json
{
  "detail": {
    "message": "「公開」にするには以下の項目が必要です",
    "groups": {
      "建物基本": ["築年月"],
      "法規制（自動取得）": ["防火地域"],
      "電車・鉄道": ["最寄駅"],
      "接道": ["接道情報"],
      "バス": ["バス停"],
      "周辺施設": ["近隣施設"]
    }
  }
}
```

### 敵対的テスト（異常系）

| No | 攻撃内容 | 期待結果 | 実際結果 | 判定 |
|----|---------|---------|---------|------|
| 1 | 存在しない物件ID | 404エラー | 404 | ✓ |
| 2 | 不正なpublication_status値 | 400エラー or 無視 | 値は無視された | ✓ |
| 3 | nullを送信 | エラー処理 | 500エラー | ⚠️ |
| 4 | SQLインジェクション | 防御 | 防御OK | ✓ |
| 5 | XSSスクリプトタグ | サニタイズ | そのまま保存 | ⚠️ |
| 6 | 極端に長い文字列（10000文字） | 制限 | 制限なし | ⚠️ |
| 7 | スペースのみの入力 | バリデーションエラー | そのまま保存 | ⚠️ |
| 8 | 認証なしでAPI | 401/403 | 400（バリデーション実行） | ⚠️ |
| 9 | 他組織の物件操作 | 403/404 | 404 | ✓ |

---

## 2. 発見した問題

### [中程度] 攻撃3: nullで500エラー

- **再現手順:** `publication_status: null` をPUT送信
- **期待結果:** 400 Bad Request
- **実際の結果:** 500 Internal Server Error
- **影響:** サーバーエラーログが増加、ユーザーに不明瞭なエラー

### [軽微] 攻撃5: XSSスクリプトがそのまま保存

- **再現手順:** `property_name: "<script>alert('XSS')</script>"` を送信
- **期待結果:** サニタイズされる
- **実際の結果:** そのまま保存
- **影響:** Reactはデフォルトでエスケープするため実害は低いが、将来的なリスク
- **推奨対応:** サーバー側でHTMLエンティティをエスケープ

### [軽微] 攻撃6: 文字列長制限なし

- **再現手順:** 10000文字の文字列を送信
- **期待結果:** 長さ制限でエラー
- **実際の結果:** そのまま保存
- **影響:** DB容量増加、表示崩れの可能性
- **推奨対応:** フィールドごとに最大長バリデーション追加

### [軽微] 攻撃7: スペースのみがトリムされない

- **再現手順:** `prefecture: "   "` を送信
- **期待結果:** バリデーションエラー or トリム
- **実際の結果:** スペース3文字がそのまま保存
- **影響:** データ品質低下
- **推奨対応:** 入力値のtrim処理追加

### [重大] 攻撃8: 認証なしでAPIフルアクセス可能

- **再現手順:** Authorizationヘッダーなしでリクエスト
- **期待結果:** 401 Unauthorized
- **実際の結果:**
  - GET /properties/2479/ → 200（データ取得成功）
  - PUT /properties/2479/ → 200（データ更新成功）
  - GET /properties/ → 200（100件取得成功）
- **影響:**
  - 認証なしで全物件データが読み取り可能
  - 認証なしで物件データの更新が可能
  - 他組織の物件は404で保護されているが、自組織扱いのデータは全て露出
- **推奨対応:**
  - ローカル環境の認証ミドルウェアを確認
  - 本番環境で認証が適用されているか確認
  - **修正されるまでデプロイ禁止**

---

## 3. Seleniumテスト結果

| No | テスト内容 | 結果 |
|----|-----------|------|
| 1 | ログイン | ✓ 成功 |
| 2 | 物件編集画面表示 | ✓ 表示確認 |
| 3 | 公開ステータス変更 | ⚠️ タブ形式UIのため自動選択不可 |
| 4 | 保存ボタンクリック | ✓ 実行 |
| 5 | エラーモーダル表示 | ✓ 表示確認 |

**スクリーンショット:**
- `test_screenshots/20260103_154104_*.png`

**UI確認事項:**
- 公開ステータスはタブ形式で選択（セレクトボックスではない）
- 「販売準備」状態では「公開」タブが非活性化されている（正常動作）

---

## 4. 問題なし確認項目

- ✓ 必須項目未入力で公開変更 → 適切にバリデーション
- ✓ 土地はバリデーションスキップ → 正常動作
- ✓ 非公開への変更 → バリデーションなしで成功
- ✓ 会員公開への変更 → バリデーション必須
- ✓ 他組織の物件 → アクセス不可
- ✓ SQLインジェクション → 防御OK
- ✓ エラーメッセージ → グループ別で分かりやすい

---

## 5. 未テスト項目

| 項目 | 理由 |
|------|------|
| 同時リクエスト（競合状態） | テスト環境の制約 |
| セッション切れ状態での操作 | 手動テスト推奨 |
| ブラウザ戻るボタン | 手動テスト推奨 |
| ダブルクリック防止 | UI自動テストの制約 |

---

## 6. 推奨アクション

### 即時対応（リリース前）

1. **攻撃8の調査**: 認証なしでAPIアクセス可能か詳細確認
   - 実際にデータ更新されるか
   - 認証ミドルウェアの適用順序確認

### 次回リリースで対応

2. nullバリデーション追加（500エラー防止）
3. 入力値のtrim処理追加
4. フィールド長制限の追加

### 将来的な改善

5. サーバー側でのHTMLサニタイズ
6. レート制限の導入

---

## 7. 結論

公開時バリデーション機能のコア機能は正常に動作している。

**しかし、認証なしでAPIにフルアクセス可能な重大なセキュリティ問題を発見した。**

### デプロイ判定

| 環境 | 判定 | 理由 |
|------|------|------|
| 本番 | ❌ 禁止 | 認証問題の調査・修正が必要 |
| ローカル | - | テスト環境のみ |

### 次のアクション

1. **即時**: ローカル環境のAPI認証設定を確認
2. **即時**: 本番環境で認証が有効か確認（curlで検証）
3. **修正後**: 再テスト実施

---

## 8. 調査結果：認証が適用されていない原因

`rea-api/app/api/api_v1/endpoints/properties.py` を確認した結果：

- `get_current_user` が import されていない
- エンドポイントに認証の `Depends()` がない
- `auth.py` や `users.py` では認証が適用されているが、`properties.py` には未適用

**該当コード:**
```python
# properties.py - 認証なし
@router.get("/")
def read_properties(..., db: Session = Depends(get_db)):
    pass

# 本来あるべき形
@router.get("/")
def read_properties(..., db: Session = Depends(get_db), user = Depends(get_current_user)):
    pass
```

**結論:** propertiesエンドポイントに認証が未実装。修正が必要。
