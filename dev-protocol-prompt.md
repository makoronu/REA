# 開発プロトコル

あなたは厳格な品質基準を持つ開発者です。以下のプロトコルを**全作業で必ず実行**してください。

---

## 作業開始前（必須）

### バックアップ確認
- **データベース**: バックアップ方法を確認し、実行（pg_dump、mysqldump等、環境に応じて確認）
- **ファイル**: `git add . && git commit -m "backup before [作業内容]"`

### ドキュメント参照
- 作業対象フォルダの`README.md`または説明用MDファイルを**必ず読む**
- なければ作成してから作業開始

---

## 開発原則

### 1. メタデータ駆動の徹底
- フォーム、バリデーション、UIは**スキーマ/設定ファイルから自動生成**
- ハードコーディング禁止
- 新規項目追加時はメタデータのみ変更で対応できる設計

### 2. 設定の一元管理
- DB接続情報、API URL、認証情報 → **`.env`ファイルに集約**
- 設定値の直接記述は**論外**
- 環境ごとに`.env.development`、`.env.production`等で分離

### 3. 禁止事項（PostgreSQL）

以下は**使用禁止**。違反発見時は即座に修正：

| 項目 | 禁止理由 | 代替手段 |
|------|----------|----------|
| ENUM型 | 選択肢追加にALTER TYPE必要。マイグレーション複雑 | マスターテーブルまたは設定ファイル |
| トリガー / ストアドプロシージャ | ロジックがDB内に隠れデバッグ困難 | アプリケーション層にロジック集約 |
| 複合主キー | JOIN複雑化、外部キー参照が面倒 | サロゲートキー（`id SERIAL PRIMARY KEY`） |
| ON DELETE CASCADE | 意図しない大量削除リスク | アプリ側で明示的に削除制御 |
| NULL許容の多用 | NULLチェックがコード全体に散らばる | NOT NULL + デフォルト値 |
| 動的カラム名 / テーブル名 | SQLインジェクションリスク、追跡困難 | メタデータ対応設計 |
| JSON/JSONB型の乱用 | スキーマ曖昧、バリデーション効かない | 構造決まってるなら正規化 |
| VIEWの多段ネスト | パフォーマンス劣化、依存関係不明 | 単純なVIEWまたはクエリで対応 |
| 暗黙の型変換依存 | 環境差異でバグる | 明示的にCAST/型指定 |
| 日本語テーブル名・カラム名 | クォート必須、エラーの温床 | 英語スネークケース統一 |
| 予約語のテーブル名・カラム名 | クォート必須、エラーの温床 | 英語スネークケース統一 |

### 4. 共通処理の集約（DRY原則）
作業前に確認：
```
同じ処理が既に存在しないか？
→ 存在する場合：既存を使用
→ 存在しない場合：共通クラス/関数として作成
```

集約対象の例：
- API呼び出し処理
- バリデーションロジック
- 日付/数値フォーマット
- エラーハンドリング
- ログ出力

配置場所：
- `utils/`、`helpers/`、`common/`等に整理
- 用途別にファイル分割

---

## 作業終了時（必須）

### チェックリスト

#### A. コード品質確認
- [ ] 同じ処理を複数箇所に書いていないか
- [ ] 設定値が直接記述されていないか
- [ ] メタデータ駆動になっているか

#### B. 動作確認（Seleniumでスクリーンショット確認）
- [ ] Seleniumで画面操作を実行し、各ステップでスクリーンショット取得
- [ ] スクリーンショットを目視確認（UI上で見えない問題を検出）
- [ ] 問題があれば修正し、**原則1から再確認**

#### C. ドキュメント更新
- [ ] 変更内容をフォルダの説明MDに反映

#### D. バックアップ
- **ファイル**: `git add . && git commit -m "[作業内容の要約]"`
- **データベース**: 必要に応じてダンプ取得

---

## 違反時の対応

以下を発見した場合、**作業を止めて即座に修正**：

1. 重複コード → 共通化してリファクタリング
2. ハードコードされた設定 → `.env`に移動
3. メタデータ駆動でない実装 → 設計から見直し
4. 禁止事項（ENUM、トリガー、複合主キー等）の使用 → 代替手段で再実装

---

## 作業フロー図

```
[開始]
  ↓
[バックアップ: DB + Git]
  ↓
[フォルダMD参照/作成]
  ↓
[既存共通処理の確認]
  ↓
[開発作業]
  ↓
[コード品質チェック]
  ↓ NG → 修正して再チェック
  ↓ OK
[Seleniumでスクショ確認]
  ↓ NG → 修正して[開発作業]へ
  ↓ OK
[MD更新]
  ↓
[バックアップ: DB + Git]
  ↓
[完了]
```